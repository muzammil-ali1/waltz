<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!--
  ~ Waltz - Enterprise Architecture
  ~ Copyright (C) 2016, 2017, 2018, 2019 Waltz open source project
  ~ See README.md for more information
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific
  ~
  -->

<!--
  ~ Waltz - Enterprise Architecture
  ~ Copyright (C) 2016, 2017, 2018, 2019 Waltz open source project
  ~ See README.md for more information
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific
  ~
  -->

<databaseChangeLog xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd"
                   logicalFilePath="db.changelog-1.3.xml">

    <!-- NOTE: if copying remember to update logical file path (above) -->
    <!-- NOTE: changes should now be described with a comment tag -->

    <!-- 1742 -->
    <changeSet id="20170228-1742-1"
               author="davidwatkins73">
        <comment>1742: create data type association table</comment>
        <createTable tableName="data_type_association"
                     remarks="Used to associate entities to data types. Entities are typically flow, specifications or applications">
            <column name="id"
                    type="${id.type}"
                    autoIncrement="true">
                <constraints nullable="false"
                             primaryKey="true"
                             primaryKeyName="data_type_association_pkey"/>
            </column>
            <column name="entity_id"
                    type="${id.type}">
                <constraints nullable="false"/>
            </column>
            <column name="entity_kind"
                    type="${enum.type}">
                <constraints nullable="false"/>
            </column>
            <column name="data_type_id"
                    type="${id.type}">
                <constraints nullable="false"/>
            </column>
            <column name="description"
                    type="${description.type}">
                <constraints nullable="true"/>
            </column>
            <column name="last_updated_at"
                    type="TIMESTAMP"
                    defaultValueComputed="${now.value}">
                <constraints nullable="false"/>
            </column>
            <column name="last_updated_by"
                    type="${name.type}">
                <constraints nullable="false"/>
            </column>
            <column name="provenance"
                    type="${provenance.type}">
                <constraints nullable="false"></constraints>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="20170303-1742-2"
               author="dwatkins">
        <comment>1742: populate associations from data_type_usage</comment>
        <sql>
            INSERT INTO data_type_association (entity_id,
                                                entity_kind,
                                                data_type_id,
                                                description,
                                                last_updated_at,
                                                last_updated_by,
                                                provenance)
            SELECT dtu.entity_id,
                    dtu.entity_kind,
                    dt.id,
                    dtu.description,
                    ${now.value},
                    'admin',
                    dtu.provenance
            FROM data_type_usage dtu
            INNER JOIN data_type dt
                ON dtu.data_type_code = dt.code;
        </sql>
    </changeSet>

    <changeSet id="20170303-1742-3"
               author="dwatkins">
        <comment>1742: populate associations from data_flow_decorator</comment>
        <sql>
            INSERT INTO data_type_association (entity_id,
                                                entity_kind,
                                                data_type_id,
                                                description,
                                                last_updated_at,
                                                last_updated_by,
                                                provenance)
            SELECT data_flow_id,
                    'LOGICAL_DATA_FLOW',
                    decorator_entity_id,
                    '',
                    ${now.value},
                    'admin',
                    provenance
            FROM data_flow_decorator
            WHERE decorator_entity_kind = 'DATA_TYPE' ;
        </sql>
    </changeSet>


    <!-- 1710: add submitted at/by to survey instance -->
    <changeSet id="20170303-1710-1"
               author="rovats">
        <addColumn tableName="survey_instance">
            <column name="submitted_at"
                    type="TIMESTAMP">
                <constraints nullable="true"></constraints>
            </column>
            <column name="submitted_by"
                    type="${name.type}">
                <constraints nullable="true"></constraints>
            </column>
        </addColumn>
    </changeSet>


    <!-- 1725 -->
    <changeSet id="20170307-1725-1"
               author="rovats">
        <comment>1725: remove trait and trait_usage</comment>
        <dropTable tableName="trait" />
        <dropTable tableName="trait_usage" />
    </changeSet>


    <!-- 1794: data type association authoritative rating -->
    <changeSet id="20170306-1794-1"
               author="davidwatkins73">
        <comment>1794: create data type association authoritative rating table</comment>
        <createTable tableName="dta_auth_rating"
                     remarks="Used to rate the authoritativeness of a data type association">
            <column name="association_id"
                    type="${id.type}">
                <constraints nullable="false"
                             primaryKey="true"
                             primaryKeyName="dta_auth_rating_pkey"/>
            </column>
            <column name="rating"
                    type="${enum.type}">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>


    <!-- 1735 -->
    <changeSet id="20170308-1735-1"
               author="rovats">
        <comment>1735: remove APP_CAPABILITY from EntityKind (migrate to MEASURABLE_RATING)</comment>
        <sql>
            UPDATE source_data_rating set
            entity_kind = 'MEASURABLE_RATING'
            WHERE entity_kind = 'APP_CAPABILITY'
        </sql>
        <sql>
            UPDATE system_job_log set
            entity_kind = 'MEASURABLE_RATING'
            WHERE entity_kind = 'APP_CAPABILITY'
        </sql>
    </changeSet>


    <!-- 1721 -->
    <changeSet id="20170309-1721-1"
               author="rovats"
               dbms="mssql"
               context="!exclude-ft">
        <comment>1721: Remove capability tables from full text index</comment>
        <sql>
            DROP FULLTEXT INDEX ON capability
        </sql>
    </changeSet>

    <changeSet id="20170309-1721-2"
               author="rovats"
               dbms="mysql">
        <comment>1721: Remove capability tables from full text index</comment>
        <dropIndex indexName="capability_content_ft_idx"
                   tableName="capability"/>
    </changeSet>


    <!-- 1811 -->
    <changeSet id="20170309-1811-1"
               author="davidwatkins73">
        <comment>1811: Remove data_type_association and dta_auth_rating tables</comment>
        <dropTable tableName="data_type_association"/>
        <dropTable tableName="dta_auth_rating" />
    </changeSet>


    <!-- 1813 -->
    <changeSet id="20170310-1814-1"
               author="davidwatkins73">
        <comment>1814: Rename data_flow_decorator table to logical_flow_decorator</comment>
        <renameTable oldTableName="data_flow_decorator"
                     newTableName="logical_flow_decorator" />
    </changeSet>

    <changeSet id="20170310-1814-2"
               author="davidwatkins73">
        <comment>1814: Update index  and column names to reflect new table name</comment>
        <dropIndex tableName="logical_flow_decorator"
                   indexName="idx_df_dec_df_id_dec_kind"/>
        <renameColumn tableName="logical_flow_decorator"
                      columnDataType="${id.type}"
                      oldColumnName="data_flow_id"
                      newColumnName="logical_flow_id"/>
        <createIndex tableName="logical_flow_decorator"
                     indexName="idx_lfd_lfid_deckind">
            <column name="logical_flow_id"/>
            <column name="decorator_entity_kind"/>
        </createIndex>
    </changeSet>


    <!-- 236 -->
    <changeSet id="20170311-236-1"
               author="davidwatkins73">
        <comment>236: Create entity tag table</comment>
        <createTable tableName="entity_tag"
                     remarks="Allows for association of zero or more tags with entities">
            <column name="entity_id"
                    type="${id.type}">
                <constraints nullable="false"/>
            </column>
            <column name="entity_kind"
                    type="${enum.type}">
                <constraints nullable="false"/>
            </column>
            <column name="tag"
                    type="${tag.type}">
                <constraints nullable="false"/>
            </column>
            <column name="last_updated_at"
                    type="TIMESTAMP"
                    defaultValueComputed="${now.value}">
                <constraints nullable="false"/>
            </column>
            <column name="last_updated_by"
                    type="${name.type}">
                <constraints nullable="false"/>
            </column>
            <column name="provenance"
                    type="${provenance.type}">
                <constraints nullable="false"></constraints>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="dwatkins"
               id="20170311-236-2">
        <comment>236: create composite key for entity tag table</comment>
        <addPrimaryKey columnNames="entity_id, entity_kind, tag"
                       constraintName="entity_tag_pkey"
                       tableName="entity_tag"/>
    </changeSet>

    <changeSet author="dwatkins"
               id="20170311-236-3">
        <comment>236: migrate application tags to entity tag table</comment>
        <sql>
            INSERT INTO entity_tag (entity_id, entity_kind, tag, last_updated_at, last_updated_by, provenance)
                SELECT application_id, 'APPLICATION', tag, ${now.value}, 'admin', 'waltz'
                FROM application_tag;
        </sql>
    </changeSet>


    <!-- 1733 -->
    <changeSet id="20170314-1733-1"
               author="rovats">
        <comment>1733: Support survey question type DROPDOWN</comment>
        <createTable tableName="survey_question_dropdown_entry"
                     remarks="Stores allowed dropdown values for a survey question">
            <column name="id"
                    type="${id.type}"
                    autoIncrement="true">
                <constraints nullable="false"
                             primaryKey="true"
                             primaryKeyName="sq_dropdown_entry_pkey"/>
            </column>
            <column name="question_id"
                    type="${id.type}">
                <constraints nullable="false"/>
            </column>
            <column name="value"
                    type="${longvarchar.type}">
                <constraints nullable="false"/>
            </column>
            <column name="position"
                    type="${int.type}">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>


    <!-- 1815 -->
    <changeSet id="20170317-1815-1"
               author="kamransaleem">
        <comment>1815: Add last_updated to logical_flow_decorator</comment>
        <addColumn tableName="logical_flow_decorator">
            <column name="last_updated_at"
                    type="TIMESTAMP"
                    defaultValueComputed="${now.value}">
                <constraints nullable="false"/>
            </column>
            <column name="last_updated_by"
                    type="${name.type}">
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="20170317-1815-2"
               author="kamransaleem">
        <comment>1815: update last_updated_by to empty</comment>
        <sql>
            UPDATE logical_flow_decorator set
            last_updated_by = 'Unknown'
        </sql>
    </changeSet>

    <changeSet id="20170317-1815-3"
               author="kamransaleem">
        <comment>1815: update last_updated_by on logical_flow-decorator to be non-nullable</comment>

        <addNotNullConstraint columnDataType="${name.type}"
                              columnName="last_updated_by"
                              tableName="logical_flow_decorator"/>
    </changeSet>


    <!-- 1727 -->
    <changeSet id="20170321-1727-1"
               author="kamransaleem">
        <comment>1727: Support question type entity</comment>
        <addColumn tableName="survey_question_response">
            <column name="entity_response_id"
                    type="${id.type}">
                <constraints nullable="true"/>
            </column>
            <column name="entity_response_kind"
                    type="${enum.type}">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>


    <!-- 1888 -->
    <changeSet id="20170329-1888-1"
               author="davidwatkins73">
        <comment>1888: Logical Flows soft delete</comment>
        <addColumn tableName="logical_flow">
            <column name="removed"
                    type="boolean"
                    defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>


    <!-- 1874 -->
    <changeSet id="20170330-1874-1"
               author="rovats"
               dbms="mssql,mysql">
        <comment>1874: Prevent duplicate survey template names</comment>
        <addUniqueConstraint columnNames="name"
                             constraintName="unique_name"
                             tableName="survey_template"/>
    </changeSet>

    <changeSet id="20170330-1874-1"
               author="davidwatkins73"
               dbms="postgresql,h2">
        <comment>1874: Prevent duplicate survey template names</comment>
        <addUniqueConstraint columnNames="name"
                             constraintName="survey_template_unique_name"
                             tableName="survey_template"/>
    </changeSet>


    <!-- 1907 -->
    <changeSet id="20170403-1907-1"
               author="rovats">
        <comment>1907: Physical Spec Definition: create tables</comment>
        <createTable tableName="physical_spec_defn"
                     remarks="Stores physical spec definition records">
            <column name="id"
                    type="${id.type}"
                    autoIncrement="true">
                <constraints nullable="false"
                             primaryKey="true"
                             primaryKeyName="physical_spec_defn_pkey"/>
            </column>
            <column name="specification_id"
                    type="${id.type}">
                <constraints nullable="false"/>
            </column>
            <column name="version"
                    type="${version.type}">
                <constraints nullable="false"/>
            </column>
            <column name="is_current"
                    type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="delimiter"
                    type="CHAR(1)">
                <constraints nullable="true"/>
            </column>
            <column name="type"
                    type="${enum.type}">
                <constraints nullable="false"/>
            </column>
            <column name="provenance"
                    type="${provenance.type}">
                <constraints nullable="false"/>
            </column>
            <column name="created_at"
                    type="TIMESTAMP"
                    defaultValueComputed="${now.value}">
                <constraints nullable="false"/>
            </column>
            <column name="created_by"
                    type="${name.type}">
                <constraints nullable="false"/>
            </column>
            <column name="last_updated_at"
                    type="TIMESTAMP"
                    defaultValueComputed="${now.value}">
                <constraints nullable="false"/>
            </column>
            <column name="last_updated_by"
                    type="${name.type}">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="20170403-1907-2"
               author="rovats">
        <comment>1907: Physical Spec Definition: create tables</comment>
        <createTable tableName="physical_spec_defn_sample_file"
                     remarks="Stores physical spec definition sample file data">
            <column name="id"
                    type="${id.type}"
                    autoIncrement="true">
                <constraints nullable="false"
                             primaryKey="true"
                             primaryKeyName="phy_spec_defn_sample_file_pkey"/>
            </column>
            <column name="spec_defn_id"
                    type="${id.type}">
                <constraints nullable="false"/>
            </column>
            <column name="name"
                    type="${name.type}">
                <constraints nullable="false"/>
            </column>
            <column name="file_data"
                    type="${clob.type}">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="20170403-1907-3"
               author="rovats">
        <comment>1907: Physical Spec Definition: create tables</comment>
        <createTable tableName="physical_spec_defn_field"
                     remarks="Stores physical spec definition fields">
            <column name="id"
                    type="${id.type}"
                    autoIncrement="true">
                <constraints nullable="false"
                             primaryKey="true"
                             primaryKeyName="physical_spec_defn_field_pkey"/>
            </column>
            <column name="spec_defn_id"
                    type="${id.type}">
                <constraints nullable="false"/>
            </column>
            <column name="name"
                    type="${name.type}">
                <constraints nullable="false"/>
            </column>
            <column name="position"
                    type="${int.type}">
                <constraints nullable="false"/>
            </column>
            <column name="type"
                    type="${enum.type}">
                <constraints nullable="false"/>
            </column>
            <column name="description"
                    type="${description.type}">
                <constraints nullable="false"/>
            </column>
            <column name="last_updated_at"
                    type="TIMESTAMP"
                    defaultValueComputed="${now.value}">
                <constraints nullable="false"/>
            </column>
            <column name="last_updated_by"
                    type="${name.type}">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>


    <!-- 1881 -->
    <changeSet id="20170331-1881-1"
               author="davidwatkins73">
        <comment>1881: Add logical flow id column to physical flow</comment>
        <addColumn tableName="physical_flow">
            <column name="logical_flow_id" type="${id.type}">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="20170331-1881-2"
               author="davidwatkins73"
               dbms="mssql,mysql">
        <comment>1881: remove flows where sender no longer exists</comment>
        <sql>
            DELETE pf
            FROM physical_flow pf
                INNER JOIN physical_specification ps
                    ON pf.specification_id = ps.id
            WHERE
                ps.owning_entity_id NOT IN (SELECT id FROM application)
                AND ps.owning_entity_kind = 'APPLICATION';
        </sql>
    </changeSet>

    <changeSet id="20170331-1881-3"
               author="davidwatkins73"
               dbms="mssql,mysql">
        <comment>1881: remove flows where target no longer exists</comment>
        <sql>
            DELETE pf
            FROM physical_flow pf
            WHERE
                pf.target_entity_id NOT IN (SELECT id FROM application)
                AND pf.target_entity_kind = 'APPLICATION';
        </sql>
    </changeSet>

    <changeSet id="20170331-1881-4a"
               author="davidwatkins73"
               dbms="mysql">
        <comment>1881: link physical flows to logical (iteration 1)</comment>
        <sql>
            UPDATE physical_flow pf
                INNER JOIN physical_specification ps
                    ON ps.id = pf.specification_id
                INNER JOIN logical_flow lf
                    ON pf.target_entity_id = lf.target_entity_id
                    AND pf.target_entity_kind = lf.target_entity_kind
                    AND ps.owning_entity_id = lf.source_entity_id
                    AND ps.owning_entity_kind = lf.source_entity_kind
            SET pf.logical_flow_id = lf.id;
        </sql>
    </changeSet>

    <changeSet id="20170331-1881-4b"
               author="davidwatkins73"
               dbms="mssql">
        <comment>1881: link physical flows to logical (iteration 1)</comment>
        <sql>
            UPDATE pf
                SET pf.logical_flow_id = lf.id
            FROM physical_flow pf
                INNER JOIN physical_specification ps
                    ON ps.id = pf.specification_id
                INNER JOIN logical_flow lf
                    ON pf.target_entity_id = lf.target_entity_id
                    AND pf.target_entity_kind = lf.target_entity_kind
                    AND ps.owning_entity_id = lf.source_entity_id
                    AND ps.owning_entity_kind = lf.source_entity_kind;
        </sql>
    </changeSet>

    <changeSet id="20170331-1881-5"
               author="davidwatkins73"
               dbms="mssql,mysql">
        <comment>1881: create missing logical flows (and mark them as removed)</comment>
        <sql>
            INSERT INTO logical_flow (
                source_entity_kind,
                source_entity_id,
                target_entity_kind,
                target_entity_id,
                provenance,
                last_updated_by,
                last_updated_at,
                removed)
            SELECT DISTINCT
                ps.owning_entity_kind AS source_entity_kind,
                ps.owning_entity_id AS source_entity_id,
                pf.target_entity_kind AS target_entity_kind,
                pf.target_entity_id AS target_entity_id,
                pf.provenance AS provenance,
                pf.last_updated_by AS last_updated_by,
                pf.last_updated_at AS last_updated_at,
                1 as removed
            FROM physical_flow pf
                INNER JOIN physical_specification ps
                    ON ps.id = pf.specification_id
            WHERE
                pf.logical_flow_id IS NULL;
        </sql>
    </changeSet>

    <changeSet id="20170331-1881-6a"
               author="davidwatkins73"
               dbms="mysql">
        <comment>1881: link physical flows to logical (iteration 2)</comment>
        <sql>
            UPDATE physical_flow pf
                INNER JOIN physical_specification ps
                    ON ps.id = pf.specification_id
                INNER JOIN logical_flow lf
                    ON pf.target_entity_id = lf.target_entity_id
                    AND pf.target_entity_kind = lf.target_entity_kind
                    AND ps.owning_entity_id = lf.source_entity_id
                    AND ps.owning_entity_kind = lf.source_entity_kind
            SET pf.logical_flow_id = lf.id;
        </sql>
    </changeSet>

    <changeSet id="20170331-1881-6b"
               author="davidwatkins73"
               dbms="mssql">
        <comment>1881: link physical flows to logical (iteration 2)</comment>
        <sql>
            UPDATE pf
                SET pf.logical_flow_id = lf.id
            FROM physical_flow pf
                INNER JOIN physical_specification ps
                    ON ps.id = pf.specification_id
                INNER JOIN logical_flow lf
                    ON pf.target_entity_id = lf.target_entity_id
                    AND pf.target_entity_kind = lf.target_entity_kind
                    AND ps.owning_entity_id = lf.source_entity_id
                    AND ps.owning_entity_kind = lf.source_entity_kind;
        </sql>
    </changeSet>

    <changeSet id="20170331-1881-7"
               author="davidwatkins73">
        <comment>1881: tighten constraint on logical_flow_id column</comment>
        <addNotNullConstraint tableName="physical_flow"
                              columnName="logical_flow_id"
                              columnDataType="${id.type}"/>
    </changeSet>

    <changeSet id="20170404-1881-8a"
               author="davidwatkins73"
               dbms="mssql,h2">
        <comment>1881: Remove indexes before removing columns</comment>
        <dropIndex tableName="physical_flow"
                   indexName="idx_target_entity"/>
    </changeSet>

    <changeSet id="20170404-1881-8b"
               author="davidwatkins73"
               dbms="mssql">
        <comment>1881: Remove default values before removing columns</comment>
        <dropDefaultValue columnDataType="${enum.type}"
                          columnName="target_entity_kind"
                          tableName="physical_flow"/>
    </changeSet>

    <changeSet id="20170404-1881-8c"
               author="davidwatkins73"
               dbms="mssql">
        <comment>1881: Remove default values before removing columns</comment>
        <dropDefaultValue columnDataType="${id.type}"
                          columnName="target_entity_id"
                          tableName="physical_flow"/>
    </changeSet>

    <changeSet id="20170331-1881-8"
               author="davidwatkins73">
        <comment>1881: remove target columns from physical_flow</comment>
        <dropColumn tableName="physical_flow"
                    columnName="target_entity_kind"/>
        <dropColumn tableName="physical_flow"
                    columnName="target_entity_id"/>
    </changeSet>

    <changeSet id="20170331-1881-9"
               author="davidwatkins73">
        <comment>1881: remove physical lineage table, to be replaced by flow diagrams</comment>
        <dropTable tableName="physical_flow_lineage"/>
    </changeSet>


    <!-- 1916 -->
    <changeSet id="20170404-1916-1"
               author="rovats"
               dbms="mssql,mysql">
        <comment>1916: Unique names required for unique names</comment>
        <dropUniqueConstraint tableName="survey_template"
                              constraintName="unique_name"
                              uniqueColumns="name" />
        <addUniqueConstraint columnNames="name"
                             constraintName="survey_template_unique_name"
                             tableName="survey_template"/>
    </changeSet>


    <!-- 1908 -->
    <changeSet id="20170404-1908-1"
               author="rovats">
        <comment>1908: Physical Spec Definition: remove is_current column</comment>
        <dropColumn tableName="physical_spec_defn"
                    columnName="is_current"/>
    </changeSet>

    <changeSet id="20170404-1908-2"
               author="rovats">
        <comment>1908: Physical Spec Definition: add status column</comment>
        <addColumn tableName="physical_spec_defn">
            <column name="status"
                    type="${enum.type}">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>


    <!-- 1922 -->
    <changeSet id="20170404-1922-1"
               author="rovats">
        <comment>1922: Physical Flow: add (optional) definition id fkey</comment>
        <addColumn tableName="physical_flow">
            <column name="specification_definition_id"
                    type="${id.type}">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>


    <!-- 1906 -->
    <changeSet id="20170404-1906-1"
               author="davidwatkins73">
        <comment>1906: The flow diagram table represents the metadata and layout data associated with a flow diagram</comment>
        <createTable tableName="flow_diagram"
                     remarks="The flow diagram table represents the metadata and layout data associated with a flow diagram">
            <column name="id"
                    autoIncrement="true"
                    type="${id.type}">
                <constraints nullable="false"
                             primaryKey="true"
                             primaryKeyName="flow_diagram_pkey"/>
            </column>
            <column name="name"
                    type="${name.type}">
                <constraints nullable="false"/>
            </column>
            <column name="description"
                    type="${description.type}">
                <constraints nullable="false"/>
            </column>
            <column name="layout_data"
                    type="${clob.type}">
                <constraints nullable="false"/>
            </column>
            <column name="last_updated_at"
                    type="TIMESTAMP"
                    defaultValueComputed="${now.value}">
                <constraints nullable="false"/>
            </column>
            <column name="last_updated_by"
                    type="${name.type}">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="20170404-1906-2"
               author="davidwatkins73">
        <comment>1906: A Bill of Materials table describing the contents of a flow diagram</comment>
        <createTable tableName="flow_diagram_entity"
                     remarks="A Bill of Materials (BoM) for a flow diagram">
            <column name="diagram_id"
                    type="${id.type}">
                <constraints nullable="false"/>
            </column>
            <column name="entity_id"
                    type="${id.type}">
                <constraints nullable="false"/>
            </column>
            <column name="entity_kind"
                    type="${enum.type}">
                <constraints nullable="false"/>
            </column>
            <column name="is_notable"
                    type="boolean"
                    defaultValueBoolean="false">
            </column>
        </createTable>

        <addPrimaryKey tableName="flow_diagram_entity"
                       constraintName="flow_diagram_entity_pkey"
                       columnNames="diagram_id, entity_id, entity_kind"/>
    </changeSet>


    <changeSet id="20170404-1906-3"
               author="davidwatkins73">
        <comment>1906: Annotations associated with a specific flow diagram</comment>
        <createTable tableName="flow_diagram_annotation"
                     remarks="Annotations associated with a specific flow diagram">
            <column name="id"
                    autoIncrement="true"
                    type="${id.type}">
                <constraints primaryKey="true"
                             primaryKeyName="flow_diagram_annotation_pkey"/>
            </column>
            <column name="diagram_id"
                    type="${id.type}">
                <constraints nullable="false"/>
            </column>
            <column name="entity_id"
                    type="${id.type}">
                <constraints nullable="false"/>
            </column>
            <column name="entity_kind"
                    type="${enum.type}">
                <constraints nullable="false"/>
            </column>
            <column name="note"
                    type="${longvarchar.type}">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>


    <!-- 1929 -->
    <changeSet id="20170406-1929-1"
               author="davidwatkins73">
        <comment>1929: Annotation id's need to be allocated up front, therefore changing to guid</comment>
        <dropTable tableName="flow_diagram_annotation"/>
        <createTable tableName="flow_diagram_annotation"
                     remarks="Annotations associated with a specific flow diagram">
            <column name="annotation_id"
                    type="${guid.type}">
                <constraints nullable="false"/>
            </column>
            <column name="diagram_id"
                    type="${id.type}">
                <constraints nullable="false"/>
            </column>
            <column name="entity_id"
                    type="${id.type}">
                <constraints nullable="false"/>
            </column>
            <column name="entity_kind"
                    type="${enum.type}">
                <constraints nullable="false"/>
            </column>
            <column name="note"
                    type="${longvarchar.type}">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey tableName="flow_diagram_annotation"
                       constraintName="flow_diagram_annotation_pkey"
                       columnNames="diagram_id, annotation_id"/>

    </changeSet>


    <!-- 1950 -->
    <changeSet id="20170407-1950-1"
               author="kamransaleem">
        <comment>1950: Logical Flows rename removed column</comment>
        <renameColumn tableName="logical_flow"
                      columnDataType="boolean"
                      oldColumnName="removed"
                      newColumnName="is_removed" />
    </changeSet>


    <!-- 1949 -->
    <changeSet id="20170407-1949-1"
               author="kamransaleem">
        <comment>1949: Application soft delete</comment>
        <addColumn tableName="application">
            <column name="is_removed"
                    type="boolean"
                    defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="20170407-1949-2"
               author="kamransaleem">
        <comment>1949: Physical Flow soft delete</comment>
        <addColumn tableName="physical_flow">
            <column name="is_removed"
                    type="boolean"
                    defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="20170407-1949-3"
               author="kamransaleem">
        <comment>1949: Physical Flow Specification soft delete</comment>
        <addColumn tableName="physical_specification">
            <column name="is_removed"
                    type="boolean"
                    defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>


    <!-- 1816 -->
    <changeSet id="20170407-1816-1"
               author="kamransaleem">
        <comment>1816: Attesting entity for implicit attestations</comment>
        <addColumn tableName="attestation">
            <column name="attesting_entity_id"
                    type="${id.type}">
                <constraints nullable="true"/>
            </column>
            <column name="attesting_entity_kind"
                    type="${enum.type}">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>


    <!-- 1959 -->
    <changeSet id="20170410-1959-1"
               author="rovats">
        <comment>1959: Spec definition: Add unique constraint on version</comment>
        <addUniqueConstraint columnNames="version"
                             constraintName="phy_spec_defn_unique_version"
                             tableName="physical_spec_defn"/>
    </changeSet>


    <!-- 1974 -->
    <changeSet author="rovats"
               id="20170411-1974-1">
        <comment>1974: Add indexes on Physical Spec Definition tables</comment>
        <createIndex indexName="idx_psd_specification_id"
                     tableName="physical_spec_defn"
                     unique="false">
            <column name="specification_id" type="${long.type}"/>
        </createIndex>
    </changeSet>

    <changeSet author="rovats"
               id="20170411-1974-2">
        <comment>1974: Add indexes on Physical Spec Definition tables</comment>
        <createIndex indexName="idx_psdf_spec_defn_id"
                     tableName="physical_spec_defn_field"
                     unique="false">
            <column name="spec_defn_id" type="${long.type}"/>
        </createIndex>
    </changeSet>

    <changeSet author="rovats"
               id="20170411-1974-3">
        <comment>1974: Add indexes on Physical Spec Definition tables</comment>
        <createIndex indexName="idx_psdsf_spec_defn_id"
                     tableName="physical_spec_defn_sample_file"
                     unique="false">
            <column name="spec_defn_id" type="${long.type}"/>
        </createIndex>
    </changeSet>


    <!-- 1928 -->
    <changeSet author="dwatkins"
               id="20170411-1928-1">
        <comment>1928: Add index to flow_diagram</comment>
        <createIndex indexName="idx_fda_diagram_id"
                     tableName="flow_diagram_annotation"
                     unique="false">
            <column name="diagram_id" type="${long.type}"/>
        </createIndex>
    </changeSet>


    <!-- 1979 -->
    <changeSet author="rovats"
               id="20170411-1979-1"
               dbms="mssql,mysql">
        <comment>1979: Logical Flows: Mark as is_removed where source/target doesn't exist</comment>
        <sql>
            UPDATE logical_flow set
                is_removed = 1
            WHERE (
                (source_entity_kind = 'APPLICATION'
                    AND source_entity_id not in (select id from application))
                OR
                (target_entity_kind = 'APPLICATION'
                    AND target_entity_id not in (select id from application))
                )
            AND is_removed = 0
        </sql>
    </changeSet>


    <!-- 2013 -->
    <changeSet id="20170418-2013-1"
               author="kamransaleem">
        <comment>2013: Spec definition: Change unique constraint to spec id, version</comment>
        <dropUniqueConstraint tableName="physical_spec_defn"
                              constraintName="phy_spec_defn_unique_version"
                              uniqueColumns="version" />

        <addUniqueConstraint columnNames="specification_id, version"
                             constraintName="phy_spec_defn_unique_version"
                             tableName="physical_spec_defn"/>
    </changeSet>
</databaseChangeLog>
